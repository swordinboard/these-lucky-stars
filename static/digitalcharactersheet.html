<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>These Lucky Stars v.4.25 - Digital Character Sheet</title>
    <link rel="stylesheet" href="/shared-colors.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }


        body {
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--body-background);
            color: var(--body-font-color);
            line-height: 1.5;
            padding: 1rem;
        }

        .home-link {
            display: inline-block;
            margin-bottom: 12px;
            color: var(--primary);
            text-decoration: none;
            font-size: 0.9em;
        }
        .home-link:hover {
            text-decoration: underline;
        }
        @media (prefers-color-scheme: dark) {
            .home-link {
                color: var(--accent);
            }
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--gray-200);
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px var(--shadow-dark), 0 2px 4px -1px var(--shadow-dark);
            border: 1px solid var(--border-color);
        }

        @media (min-width: 1100px) {
            body {
                padding: 2rem 3rem;
            }
        }

        @media (min-width: 1400px) {
            body {
                padding: 2rem calc((100vw - 1000px) / 2);
                padding-top: 2rem;
                padding-bottom: 2rem;
            }
        }

        .header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            text-align: center;
            position: relative;
            overflow: visible;
        }
        .header h1 { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; }
        
        .approval-stamp {
            position: absolute;
            top: 25px;
            right: -5px;
            transform: rotate(35deg);
            font-family: 'Stencil', 'Impact', 'Arial Black', sans-serif;
            color: var(--stamp-color);
            border: 3px solid var(--stamp-color);
            border-radius: 8px;
            padding: 6px 14px;
            font-size: 0.9rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 3px;
            background: var(--shadow-light);
            pointer-events: none;
            z-index: 100;
            display: none;
            text-align: center;
            line-height: 1.2;
        }
        .approval-stamp.visible { display: block; }
        .approval-stamp .stamp-edited {
            font-size: 0.6rem;
            color: var(--stamp-color);
            margin-top: 2px;
            letter-spacing: 2px;
            display: none;
        }
        .approval-stamp .stamp-edited.visible { display: block; }
        
        .readme-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--shadow-light);
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            background: var(--shadow-light);
            color: white;
            transition: all 0.2s;
        }
        .readme-btn:hover {
            background: var(--shadow-light);
            filter: brightness(1.5);
        }

        .controls {
            background: var(--gray-100);
            padding: 0.75rem;
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            background: var(--accent);
            color: white;
        }
        .btn:hover { background: var(--accent-secondary); }
        .btn-secondary {
            background: var(--accent-secondary);
        }
        .btn-secondary:hover { background: var(--primary); }

        .tabs {
            background: var(--gray-100);
            padding: 0.75rem;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }
        .tab-list { display: flex; gap: 0.25rem; flex-wrap: wrap; }
        .tab-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem 0.5rem 0 0;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            background: var(--gray-200);
            color: var(--body-font-color);
            transition: all 0.2s;
        }
        .tab-btn:hover { background: var(--gray-100); }
        .tab-btn.active { background: var(--primary); color: white; }

        .tab-content {
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
        }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        .section { margin-bottom: 1.5rem; }
        .section:last-child { margin-bottom: 0; }

        .section-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            user-select: none;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }
        .section-title:hover { background: var(--gray-100); }
        .section-title .collapse-icon {
            transition: transform 0.2s;
            margin-left: auto;
            color: var(--gray-500);
        }
        .section-title.collapsed .collapse-icon { transform: rotate(-90deg); }
        .section-content { transition: all 0.2s; }
        .section-content.collapsed { display: none; }

        .grid { display: grid; gap: 1rem; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
        }

        .grid-2-persistent { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .form-label-sm {
            font-size: 0.75rem;
            color: var(--gray-500);
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-family: inherit;
            background: var(--body-background);
            color: var(--body-font-color);
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        input[type="number"] { text-align: center; }
        textarea { resize: vertical; min-height: 5rem; }
        textarea.auto-expand { overflow: hidden; resize: none; }

        /* Attribute & Stat Blocks - Unified neutral background */
        .attr-block, .stat-box, .card-block {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            background: var(--gray-100);
        }
        
        @media (max-width: 400px) {
            .attr-block {
                padding: 0.5rem;
            }
        }

        .attr-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .attr-icon { width: 1.25rem; height: 1.25rem; color: var(--accent); flex-shrink: 0; }
        .attr-inputs { display: flex; flex-direction: column; gap: 0.25rem; margin-top: 0.5rem; }
        .attr-inputs > div { display: flex; align-items: center; gap: 0.5rem; }
        .attr-inputs label { width: 2.5rem; font-size: 0.7rem; }
        .attr-inputs input { flex: 1; }
        .attr-total { text-align: center; margin-bottom: 0.5rem; }
        .attr-total-value { font-size: 1.125rem; font-weight: 700; color: var(--primary); }
        @media (prefers-color-scheme: dark) {
            .attr-total-value { color: var(--accent); }
        }
        .attr-total-label, .size-note { font-size: 0.75rem; color: var(--gray-500); }
        
        .attr-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 0.75rem; 
        }
        @media (max-width: 320px) { 
            .attr-grid { grid-template-columns: 1fr; } 
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        .stat-grid .full-row {
            grid-column: 1 / -1;
        }
        @media (max-width: 320px) {
            .stat-grid { grid-template-columns: 1fr; }
            .stat-grid .full-row { grid-column: 1; }
        }

        .stat-label { font-size: 0.875rem; font-weight: 700; margin-bottom: 0.5rem; }
        .stat-value { font-size: 1.25rem; font-weight: 700; text-align: center; margin-bottom: 0.25rem; }
        .stat-formula {
            font-size: 0.7rem;
            color: var(--gray-500);
            text-align: center;
            background: var(--shadow-light);
            padding: 0.25rem;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
            font-family: monospace;
        }
        @media (prefers-color-scheme: dark) {
            .stat-formula {
                background: var(--shadow-dark);
            }
        }
        .stat-formula.hidden-formula { display: none; }

        .input-group { display: flex; flex-direction: column; }
        .input-group label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--gray-500);
            margin-bottom: 0.125rem;
        }
        .input-group input { padding: 0.25rem; font-size: 0.8rem; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        .input-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; }

        /* Equipment Blocks */
        .card-block {
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .card-block:last-child { margin-bottom: 0; }
        .card-header { font-weight: 600; margin-bottom: 0.75rem; font-size: 1rem; }

        .stats-row-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
        .stats-row-2 { display: flex; gap: 0.5rem; }
        .stat-small { width: 80px; flex-shrink: 0; }
        .stat-small label { font-size: 0.7rem; font-weight: 600; color: var(--gray-500); display: block; margin-bottom: 0.125rem; }
        .stat-small input { padding: 0.375rem; font-size: 0.8rem; }
        .notes-area { flex: 1; }
        .notes-area label { font-size: 0.75rem; font-weight: 600; color: var(--gray-500); display: block; margin-bottom: 0.125rem; }
        .notes-area textarea { min-height: 2.5rem; padding: 0.375rem; font-size: 0.85rem; }

        /* Wounds & Slots */
        .list-vertical { display: flex; flex-direction: column; gap: 0.5rem; }
        .slot-row { display: grid; grid-template-columns: 100px 1fr; gap: 0.5rem; align-items: center; }
        .slot-row label { font-size: 0.875rem; font-weight: 600; }

        /* Inventory */
        .summary-box {
            background: var(--gray-100);
            padding: 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid var(--border-color);
        }
        .summary-box .formula-display {
            font-size: 0.7rem;
            color: var(--gray-500);
            font-family: monospace;
            background: var(--shadow-light);
            padding: 0.125rem 0.25rem;
            border-radius: 0.125rem;
            margin-top: 0.25rem;
        }
        @media (prefers-color-scheme: dark) {
            .summary-box .formula-display {
                background: var(--shadow-dark);
            }
        }
        .summary-box .formula-display.hidden-formula { display: none; }
        .mod-row { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.25rem; }
        .mod-row label { font-size: 0.7rem; font-weight: 600; color: var(--gray-500); }
        .mod-row input { width: 50px; padding: 0.25rem; font-size: 0.75rem; }

        .inv-header, .inv-row { display: grid; grid-template-columns: 8fr 2fr 2fr; gap: 0.5rem; }
        .inv-header { font-size: 0.75rem; font-weight: 600; color: var(--gray-500); margin-bottom: 0.25rem; padding: 0 0.25rem; }
        .inv-row { margin-bottom: 0.25rem; }
        .inv-row input, .inv-row select { padding: 0.25rem 0.5rem; font-size: 0.875rem; }

        .dual-col { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .dual-col textarea { min-height: 3rem; }
        @media (max-width: 768px) { .dual-col { grid-template-columns: 1fr; } }

        .totals-box { background: var(--gray-200); padding: 0.75rem; border-radius: 0.5rem; margin-top: 0.5rem; }
        .totals-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; text-align: center; }

        .combined-stat { display: flex; gap: 1rem; align-items: center; justify-content: center; }
        .combined-stat-item { text-align: center; }
        .combined-stat-item .value { font-size: 1.125rem; font-weight: 700; }
        .combined-stat-item .label { font-size: 0.7rem; color: var(--gray-500); }
        .combined-stat-sep { font-size: 1.25rem; color: var(--gray-500); }

        .features-grid, .notes-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .features-grid textarea { min-height: 12rem; }
        .notes-grid textarea { min-height: 10rem; }
        @media (max-width: 768px) { .features-grid, .notes-grid { grid-template-columns: 1fr; } }

        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .mb-05 { margin-bottom: 0.5rem; }
        .mt-05 { margin-top: 0.5rem; }

        /* Modal */
        .modal-overlay {
            position: fixed; inset: 0;
            background: var(--shadow-dark);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; padding: 1rem;
        }
        .modal {
            background: var(--body-background);
            color: var(--body-font-color);
            border-radius: 0.5rem;
            padding: 1.5rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-title { font-size: 1.25rem; font-weight: 700; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray-500); }
        .modal-close:hover { color: var(--body-font-color); }
        .modal-body { font-size: 0.875rem; line-height: 1.6; }
        .modal-body p { margin-bottom: 1rem; }
        .modal-body h3 { font-weight: 600; margin-bottom: 0.5rem; }
        .modal-footer { margin-top: 1.5rem; display: flex; justify-content: flex-end; }

        .icon { width: 1rem; height: 1rem; display: inline-block; vertical-align: middle; }
        .icon-lg { width: 1.25rem; height: 1.25rem; }

        /* Full-width stat with side-by-side layout */
        .stat-box-full-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            align-items: start;
        }
        .stat-box-full-split .stat-main {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        .stat-box-full-split .stat-notes {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        .stat-box-full-split .stat-notes .input-group {
            display: flex;
            flex-direction: column;
        }
        .stat-box-full-split .stat-notes textarea {
            min-height: 4rem;
        }
        @media (max-width: 400px) {
            .stat-box-full-split {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <a href="https://theseluckystars.com" class="home-link">‚Üê Home</a>
    <div class="container">
        <div class="header">
            <h1>These Lucky Stars v.4.25 - Digital Character Sheet</h1>
            <button class="readme-btn" onclick="showReadme()">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Alpha Version Read Me
            </button>
            <div id="approvalStamp" class="approval-stamp">
                <div id="stampMessage"></div>
                <div id="stampEdited" class="stamp-edited">EDITED</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn" onclick="saveCharacter()">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                Save Sheet
            </button>
            <button class="btn" onclick="document.getElementById('fileInput').click()">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                Load Sheet
            </button>
            <button class="btn btn-secondary" onclick="showHelp()">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                How To Use
            </button>
            <button class="btn btn-secondary" id="formulaToggle" onclick="toggleFormulas()">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                <span id="formulaToggleText">Show Formulas</span>
            </button>
            <input type="file" id="fileInput" accept=".json" style="display:none" onchange="loadCharacter(event)">
        </div>

        <div class="tabs">
            <div class="tab-list">
                <button class="tab-btn active" data-tab="overview" onclick="switchTab('overview')">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                    Overview
                </button>
                <button class="tab-btn" data-tab="features" onclick="switchTab('features')">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>
                    Features
                </button>
                <button class="tab-btn" data-tab="combat" onclick="switchTab('combat')">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                    Combat
                </button>
                <button class="tab-btn" data-tab="equipment" onclick="switchTab('equipment')">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                    Equipment
                </button>
                <button class="tab-btn" data-tab="inventory" onclick="switchTab('inventory')">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                    Inventory
                </button>
                <button class="tab-btn" data-tab="notes" onclick="switchTab('notes')">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                    Notes
                </button>
            </div>
        </div>

        <div class="tab-content">
            <!-- OVERVIEW TAB -->
            <div id="overview" class="tab-panel active">
                <div class="section">
                    <h3 class="section-title" onclick="toggleSection(this)">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        Character Info
                        <svg class="icon collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </h3>
                    <div class="section-content">
                        <div class="grid grid-2">
                            <div class="input-group"><label class="form-label">Character Name</label><input type="text" id="characterName" placeholder="Enter name" onchange="updateCharacter()"></div>
                            <div class="input-group"><label class="form-label">Player Name</label><input type="text" id="playerName" placeholder="Your name" onchange="updateCharacter()"></div>
                        </div>
                        <div class="grid grid-2 mt-05">
                            <div class="input-group"><label class="form-label">Archetype</label><input type="text" id="archetype" placeholder="Class/Archetype" onchange="updateCharacter()"></div>
                            <div class="input-group"><label class="form-label">Level</label><input type="number" id="level" placeholder="1" min="1" onchange="updateCharacter()"></div>
                        </div>
                        <div class="input-group mt-05"><label class="form-label">Description</label><textarea id="description" class="auto-expand" placeholder="Appearance, background..." oninput="autoExpand(this)" onchange="updateCharacter()"></textarea></div>
                        <div class="grid grid-3 mt-05">
                            <div class="input-group"><label class="form-label">Height</label><input type="text" id="height" placeholder="5'10&quot;" onchange="updateCharacter()"></div>
                            <div class="input-group"><label class="form-label">Weight</label><input type="text" id="weight" placeholder="175 lbs" onchange="updateCharacter()"></div>
                            <div class="input-group">
                                <label class="form-label">Size</label>
                                <select id="size" onchange="updateCharacter()">
                                    <option value="Tiny/-2">Tiny (-2)</option>
                                    <option value="Small/-1">Small (-1)</option>
                                    <option value="Medium/0" selected>Medium (0)</option>
                                    <option value="Large/+1">Large (+1)</option>
                                    <option value="Huge/+2">Huge (+2)</option>
                                </select>
                                <span class="size-note">Affects STR, AGI, Grapple, Stealth</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title" onclick="toggleSection(this)">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
                        Physical Attributes
                        <svg class="icon collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </h3>
                    <div class="section-content">
                        <div class="attr-grid" id="physicalAttrsContainer"></div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title" onclick="toggleSection(this)">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                        Mental Attributes
                        <svg class="icon collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </h3>
                    <div class="section-content">
                        <div class="attr-grid" id="mentalAttrsContainer"></div>
                    </div>
                </div>
            </div>

            <!-- FEATURES TAB -->
            <div id="features" class="tab-panel">
                <div class="section">
                    <h3 class="section-title" onclick="toggleSection(this)">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>
                        Traits
                        <svg class="icon collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </h3>
                    <div class="section-content">
                        <textarea id="traits" class="auto-expand" style="min-height: 8rem;" placeholder="Racial traits, backgrounds..." oninput="autoExpand(this)" onchange="updateCharacter()"></textarea>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title" onclick="toggleSection(this)">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
                        Proficiencies
                        <svg class="icon collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </h3>
                    <div class="section-content">
                        <textarea id="proficiencies" class="auto-expand" style="min-height: 8rem;" placeholder="Weapons, armor, tools..." oninput="autoExpand(this)" onchange="updateCharacter()"></textarea>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title" onclick="toggleSection(this)">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                        Abilities
                        <svg class="icon collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </h3>
                    <div class="section-content">
                        <textarea id="abilities" class="auto-expand" style="min-height: 15rem;" placeholder="Class features, special abilities..." oninput="autoExpand(this)" onchange="updateCharacter()"></textarea>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title" onclick="toggleSection(this)">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/></svg>
                        Languages
                        <svg class="icon collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </h3>
                    <div class="section-content">
                        <textarea id="languages" class="auto-expand" placeholder="Common, Elvish..." oninput="autoExpand(this)" onchange="updateCharacter()"></textarea>
                    </div>
                </div>
            </div>

            <!-- COMBAT TAB -->
            <div id="combat" class="tab-panel">
                <div class="section">
                    <h3 class="section-title" onclick="toggleSection(this)">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                        Stats
                        <svg class="icon collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </h3>
                    <div class="section-content">
                        <div class="stat-grid" id="statsContainer"></div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title" onclick="toggleSection(this)">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                        Health
                        <svg class="icon collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </h3>
                    <div class="section-content">
                        <div class="stat-grid" id="healthContainer"></div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title" onclick="toggleSection(this)">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        Wounds & Conditions
                        <svg class="icon collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </h3>
                    <div class="section-content">
                        <div class="list-vertical" id="woundsContainer"></div>
                    </div>
                </div>
            </div>

            <!-- EQUIPMENT TAB -->
            <div id="equipment" class="tab-panel">
                <div class="section">
                    <h3 class="section-title" onclick="toggleSection(this)">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                        Weapons
                        <svg class="icon collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </h3>
                    <div class="section-content">
                        <div id="weaponsContainer"></div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title" onclick="toggleSection(this)">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                        Armor & Equipment
                        <svg class="icon collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </h3>
                    <div class="section-content">
                        <div id="defenseContainer"></div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title" onclick="toggleSection(this)">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                        Equipment Slots
                        <svg class="icon collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </h3>
                    <div class="section-content">
                        <div class="list-vertical" id="equipmentSlotsContainer"></div>
                    </div>
                </div>
            </div>

            <!-- INVENTORY TAB -->
            <div id="inventory" class="tab-panel">
                <div class="section">
                    <h3 class="section-title" onclick="toggleSection(this)">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/></svg>
                        Capacity
                        <svg class="icon collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </h3>
                    <div class="section-content">
                        <div class="dual-col" id="inventorySummary"></div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title" onclick="toggleSection(this)">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                        Items
                        <svg class="icon collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </h3>
                    <div class="section-content">
                        <div class="inv-header"><span>Item Name</span><span>Weight</span><span>Bulky?</span></div>
                        <div id="inventoryItemsContainer"></div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title" onclick="toggleSection(this)">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                        Currency & Notes
                        <svg class="icon collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </h3>
                    <div class="section-content">
                        <div class="input-group mb-05"><label>Currency</label><textarea id="currency" class="auto-expand" style="min-height: 2.5rem;" placeholder="Credits, coins, etc..." oninput="autoExpand(this)" onchange="updateCharacter()"></textarea></div>
                        <div class="input-group"><label>Inventory Notes</label><textarea id="inventoryNotes" class="auto-expand" style="min-height: 3rem;" placeholder="Special items, notes about gear..." oninput="autoExpand(this)" onchange="updateCharacter()"></textarea></div>
                    </div>
                </div>
            </div>

            <!-- NOTES TAB -->
            <div id="notes" class="tab-panel">
                <div class="section">
                    <h3 class="section-title" onclick="toggleSection(this)">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        Notes
                        <svg class="icon collapse-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </h3>
                    <div class="section-content">
                        <div class="notes-grid">
                            <div class="input-group"><label>Notes 1</label><textarea id="notes1" class="auto-expand" oninput="autoExpand(this)" onchange="updateCharacter()"></textarea></div>
                            <div class="input-group"><label>Notes 2</label><textarea id="notes2" class="auto-expand" oninput="autoExpand(this)" onchange="updateCharacter()"></textarea></div>
                            <div class="input-group"><label>Notes 3</label><textarea id="notes3" class="auto-expand" oninput="autoExpand(this)" onchange="updateCharacter()"></textarea></div>
                            <div class="input-group"><label>Notes 4</label><textarea id="notes4" class="auto-expand" oninput="autoExpand(this)" onchange="updateCharacter()"></textarea></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">How to Use This Character Sheet</span>
                <button class="modal-close" onclick="hideHelp()">&times;</button>
            </div>
            <div class="modal-body">
                <p><strong>Save/Load:</strong> Use the Save Sheet button to download your character as a JSON file. Use Load Sheet to restore from a saved file.</p>
                <p><strong>Tabs:</strong> Navigate between Overview, Features, Combat, Equipment, Inventory, and Notes tabs to access different parts of your character sheet.</p>
                <p><strong>Collapsible Sections:</strong> Click on section headers to expand or collapse them.</p>
                <p><strong>Formulas:</strong> Toggle formula visibility with the Show/Hide Formulas button. Formulas show how stats are calculated.</p>
                <p><strong>Auto-Calculate:</strong> Most derived stats update automatically when you change base values.</p>
                <h3>Combat Tab</h3>
                <p>The Combat tab contains your Stats (Initiative, Action Points, Luck, Speed, Grapple, Stealth) and Health (Defense, Vitality, Tracker, Stress Threshold) sections along with Wounds & Conditions.</p>
            </div>
            <div class="modal-footer"><button class="btn" onclick="hideHelp()">Got it!</button></div>
        </div>
    </div>

    <!-- Readme Modal -->
    <div id="readmeModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Alpha Version Read Me</span>
                <button class="modal-close" onclick="hideReadme()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Dear friends,</p>
                <p>This little app is getting close to finished now. At least by my eyes, I'm sure there's some things that could be tweaked and I would really love some feedback on it. Things that could be changed, adjusted, how it fits on different screens, and missing features are all much appreciated.</p>
                <p>If you've made it this far, I don't have to tell you how to make it run. And it also means the buttons are working, so the JavaScript should be good.</p>
                <p>I vibe coded this whole thing. It has taken me four days of full credits for Claude.ai night and day. I've learned a bit about coding as I went but I'm still very very green. So if you have experience in that area and find ways to improve on what front end eyes would miss please boss me around.</p>
                <p>I hope to release this on the (upcoming) website once parts of the rule set are set in stone. For now there are lots of changes happening, but I thought this would be a fun project to try out now and be nice for everybody to have while playing. I've always been a fan of a paper sheet, but I know there's a lot of value in a digital one.</p>
                <p>Fighting imposter syndrome with sharp stick,<br>-Anthony DiRuzza</p>
            </div>
            <div class="modal-footer"><button class="btn" onclick="hideReadme()">Close</button></div>
        </div>
    </div>

    <script>
        // ===== CONSTANTS =====
        const ATTRS = {
            physical: [
                { id: 'str', label: 'STR', icon: '<svg class="attr-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>' },
                { id: 'agi', label: 'AGI', icon: '<svg class="attr-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>' },
                { id: 'dex', label: 'DEX', icon: '<svg class="attr-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11"/></svg>' },
                { id: 'fort', label: 'FORT', icon: '<svg class="attr-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>' }
            ],
            mental: [
                { id: 'kno', label: 'KNO', icon: '<svg class="attr-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>' },
                { id: 'ins', label: 'INS', icon: '<svg class="attr-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>' },
                { id: 'cha', label: 'CHA', icon: '<svg class="attr-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>' },
                { id: 'will', label: 'WILL', icon: '<svg class="attr-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>' }
            ]
        };

        const EQUIPMENT_SLOTS = ['Head', 'Neck', 'Chest', 'Back', 'Arms', 'Hands', 'Belt', 'Legs/Feet'];

        const SIZE_MODS = {
            'Tiny/-2': { str: -4, agi: 4, grapple: -4, stealth: 4 },
            'Small/-1': { str: -2, agi: 2, grapple: -2, stealth: 2 },
            'Medium/0': { str: 0, agi: 0, grapple: 0, stealth: 0 },
            'Large/+1': { str: 2, agi: -2, grapple: 2, stealth: -2 },
            'Huge/+2': { str: 4, agi: -4, grapple: 4, stealth: -4 }
        };

        // ===== STATE =====
        let character = {
            characterName: '', playerName: '', archetype: '', level: null,
            description: '', height: '', weight: '', size: 'Medium/0',
            str: { base: 0, mods: 0 }, agi: { base: 0, mods: 0 },
            dex: { base: 0, mods: 0 }, fort: { base: 0, mods: 0 },
            kno: { base: 0, mods: 0 }, ins: { base: 0, mods: 0 },
            cha: { base: 0, mods: 0 }, will: { base: 0, mods: 0 },
            luckBase: 5, luckMods: 0, currentLuck: 5,
            currentVitality: 1, vitalityMods: 0,
            currentDefense: 0, defenseMods: 0,
            currentStress: 0, stressMods: 0,
            tracker: '',
            initiativeMods: 0, initiativeNotes: '',
            actionPointsMods: 0, speedMods: 0, speedNotes: '',
            grappleMods: 0, stealthMods: 0,
            weapons: Array(3).fill().map(() => ({ name: '', atkBonus: '', dmg: '', ammo: '', notes: '' })),
            armor: { name: '', defBonus: 0, dexAgiPenalty: 0, notes: '' },
            equipment: { name: '', defBonus: 0, dexAgiPenalty: 0, notes: '' },
            equipmentSlots: { head: '', neck: '', chest: '', back: '', arms: '', hands: '', belt: '', legsFeet: '' },
            maxWeightMods: 0, maxBulkyMods: 0, inventoryNotes: '', currency: '', languages: '',
            inventoryItems: Array(20).fill().map(() => ({ name: '', weight: 0, bulky: false })),
            woundsConditions: Array(10).fill(''),
            traits: '', proficiencies: '', abilities: '', healthNotes: '', additionalStats: '',
            notes1: '', notes2: '', notes3: '', notes4: '',
            _approvalStamp: '',
            _approvalEdited: false
        };

        let formulasVisible = false;
        let stampWasLoaded = false;

        // ===== HELPERS =====
        const $ = id => document.getElementById(id);
        const val = id => parseInt($(id)?.value) || 0;
        const fval = id => parseFloat($(id)?.value) || 0;
        const sval = id => $(id)?.value || '';

        function autoExpand(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        function toggleSection(el) {
            el.classList.toggle('collapsed');
            const content = el.nextElementSibling;
            if (content) content.classList.toggle('collapsed');
        }

        function toggleFormulas() {
            formulasVisible = !formulasVisible;
            document.querySelectorAll('.stat-formula, .formula-display').forEach(el => {
                el.classList.toggle('hidden-formula', !formulasVisible);
            });
            $('formulaToggleText').textContent = formulasVisible ? 'Hide Formulas' : 'Show Formulas';
        }

        // ===== CALCULATIONS =====
        function getAttrTotal(id) {
            const base = val(id + 'Base');
            const mods = val(id + 'Mods');
            const sizeMod = SIZE_MODS[sval('size')] || SIZE_MODS['Medium/0'];
            const sizeBonus = (id === 'str' || id === 'agi') ? (sizeMod[id] || 0) : 0;
            return base + mods + sizeBonus;
        }

        function calculateDerivedStats() {
            const str = getAttrTotal('str');
            const agi = getAttrTotal('agi');
            const dex = getAttrTotal('dex');
            const fort = getAttrTotal('fort');
            const ins = getAttrTotal('ins');
            const will = getAttrTotal('will');
            const level = val('level') || 0;
            const sizeMod = SIZE_MODS[sval('size')] || SIZE_MODS['Medium/0'];

            // Update attribute displays
            [...ATTRS.physical, ...ATTRS.mental].forEach(attr => {
                const total = getAttrTotal(attr.id);
                $(attr.id + 'Total').textContent = total >= 0 ? '+' + total : total;
            });

            // Initiative
            const initMods = val('initiativeMods');
            const initiative = agi + dex + ins + initMods;
            $('initiativeDisplay').textContent = initiative >= 0 ? '+' + initiative : initiative;
            $('initiativeFormula').textContent = `AGI(${agi}) + DEX(${dex}) + INS(${ins}) + Mods(${initMods}) = ${initiative}`;

            // Action Points
            const apMods = val('actionPointsMods');
            const ap = 4 + apMods;
            $('apDisplay').textContent = ap;
            $('apFormula').textContent = `Base(4) + Mods(${apMods}) = ${ap}`;

            // Luck
            const luckBase = val('luckBase');
            const luckMods = val('luckMods');
            const maxLuck = luckBase + luckMods;
            $('luckDisplay').textContent = maxLuck;
            $('luckFormula').textContent = `Base(${luckBase}) + Mods(${luckMods}) = ${maxLuck}`;

            // Speed
            const speedMods = val('speedMods');
            const agiBonus = Math.max(0, agi) * 5;
            const speed = 20 + agiBonus + speedMods;
            $('speedDisplay').textContent = speed + ' ft';
            $('speedFormula').textContent = `20 + AGI Bonus(${agiBonus}) + Mods(${speedMods}) = ${speed}`;

            // Grapple
            const grappleMods = val('grappleMods');
            const grapple = str + agi + (sizeMod.grapple || 0) + grappleMods;
            $('grappleDisplay').textContent = grapple >= 0 ? '+' + grapple : grapple;
            $('grappleFormula').textContent = `STR(${str}) + AGI(${agi}) + Size(${sizeMod.grapple || 0}) + Mods(${grappleMods}) = ${grapple}`;

            // Stealth
            const stealthMods = val('stealthMods');
            const stealth = (sizeMod.stealth || 0) + stealthMods;
            $('stealthDisplay').textContent = stealth >= 0 ? '+' + stealth : stealth;
            $('stealthFormula').textContent = `Size(${sizeMod.stealth || 0}) + Mods(${stealthMods}) = ${stealth}`;

            // Defense
            const armorDef = val('armorDefBonus');
            const equipDef = val('equipmentDefBonus');
            const defenseMods = val('defenseMods');
            const defense = Math.max(1, agi + fort + armorDef + equipDef + defenseMods);
            $('defenseDisplay').textContent = defense;
            $('defenseFormula').textContent = `AGI(${agi}) + FORT(${fort}) + Equip(${armorDef + equipDef}) + Mods(${defenseMods}) = ${defense} (min 1)`;

            // Vitality
            const vitalityMods = val('vitalityMods');
            const vitality = Math.floor(level / 2) + Math.floor(fort / 2) + vitalityMods;
            $('vitalityDisplay').textContent = level > 0 ? vitality : 'n/a';
            $('vitalityFormula').textContent = `¬Ω Level(${Math.floor(level/2)}) + ¬Ω FORT(${Math.floor(fort/2)}) + Mods(${vitalityMods}) = ${vitality}`;

            // Stress Threshold
            const stressMods = val('stressMods');
            const stressThreshold = Math.max(1, Math.floor(level / 2) + Math.floor(will / 2) + stressMods);
            $('stressThresholdDisplay').textContent = level > 0 ? stressThreshold : 'n/a';
            $('stressFormula').textContent = `¬Ω Level(${Math.floor(level/2)}) + ¬Ω WILL(${Math.floor(will/2)}) + Mods(${stressMods}) = ${stressThreshold} (min 1)`;

            // Equipment totals
            const armorPenalty = val('armorPenalty');
            const equipPenalty = val('equipmentPenalty');
            $('totalDefBonus').textContent = '+' + (armorDef + equipDef);
            $('totalPenalty').textContent = (armorPenalty + equipPenalty);

            // Inventory
            const maxWeightMods = val('maxWeightMods');
            const maxWeight = str * 25 + maxWeightMods;
            let currentWeight = 0;
            let currentBulky = 0;
            for (let i = 0; i < 20; i++) {
                currentWeight += fval('itemWeight' + i);
                if ($('itemBulky' + i)?.value === 'yes') currentBulky++;
            }
            $('currentWeightDisplay').textContent = currentWeight.toFixed(1);
            $('maxWeightDisplay').textContent = maxWeight;
            $('maxWeightFormula').textContent = `Max = STR(${str}) √ó 25 + Mods(${maxWeightMods}) = ${maxWeight}`;

            const maxBulkyMods = val('maxBulkyMods');
            const maxBulky = 1 + Math.floor(str / 5) + maxBulkyMods;
            $('currentBulkyDisplay').textContent = currentBulky;
            $('maxBulkyDisplay').textContent = maxBulky;
            $('maxBulkyFormula').textContent = `Max = 1 + STR√∑5(${Math.floor(str/5)}) + Mods(${maxBulkyMods}) = ${maxBulky}`;
        }

        // ===== GENERATORS =====
        function generateAttrs() {
            const makeAttrBlock = attr => `
                <div class="attr-block">
                    <div class="attr-header">
                        ${attr.icon}
                        <label class="form-label" style="margin:0;">${attr.label}:</label>
                    </div>
                    <div class="attr-total">
                        <div class="attr-total-value" id="${attr.id}Total">0</div>
                        <div class="attr-total-label">Total</div>
                    </div>
                    <div class="attr-inputs">
                        <div><label class="form-label-sm">Base</label><input type="number" id="${attr.id}Base" value="0" onchange="updateCharacter()"></div>
                        <div><label class="form-label-sm">Mods</label><input type="number" id="${attr.id}Mods" value="0" onchange="updateCharacter()"></div>
                    </div>
                </div>`;
            $('physicalAttrsContainer').innerHTML = ATTRS.physical.map(makeAttrBlock).join('');
            $('mentalAttrsContainer').innerHTML = ATTRS.mental.map(makeAttrBlock).join('');
        }

        function generateStats() {
            $('statsContainer').innerHTML = `
                <!-- Initiative - Full Row with side-by-side layout -->
                <div class="stat-box full-row">
                    <div class="stat-box-full-split">
                        <div class="stat-main">
                            <div class="stat-label">Initiative</div>
                            <div class="stat-value" id="initiativeDisplay">0</div>
                            <div class="stat-formula hidden-formula" id="initiativeFormula">AGI + DEX + INS + Mods = 0</div>
                            <div class="input-group"><label>Mods</label><input type="number" id="initiativeMods" value="0" onchange="updateCharacter()"></div>
                        </div>
                        <div class="stat-notes">
                            <div class="input-group">
                                <label>Notes</label>
                                <textarea id="initiativeNotes" class="auto-expand" oninput="autoExpand(this)" onchange="updateCharacter()"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Action Points | Luck -->
                <div class="stat-box">
                    <div class="stat-label">Action Points</div>
                    <div class="stat-value" id="apDisplay">4</div>
                    <div class="stat-formula hidden-formula" id="apFormula">Base(4) + Mods(0) = 4</div>
                    <div class="input-group"><label>Mods</label><input type="number" id="actionPointsMods" value="0" onchange="updateCharacter()"></div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Luck</div>
                    <div class="combined-stat mb-05">
                        <div class="combined-stat-item"><div class="stat-value" id="luckDisplay" style="margin:0">5</div><div class="label">Max</div></div>
                        <div class="combined-stat-item"><input type="number" id="currentLuck" value="5" style="width:50px;padding:0.25rem;font-size:1rem;font-weight:700" onchange="updateCharacter()"><div class="label">Current</div></div>
                    </div>
                    <div class="stat-formula hidden-formula" id="luckFormula">Base(5) + Mods(0) = 5</div>
                    <div class="input-row"><div class="input-group"><label>Base</label><input type="number" id="luckBase" value="5" onchange="updateCharacter()"></div><div class="input-group"><label>Mods</label><input type="number" id="luckMods" value="0" onchange="updateCharacter()"></div></div>
                </div>
                <!-- Speed - Full Row -->
                <div class="stat-box full-row">
                    <div class="stat-box-full-split">
                        <div class="stat-main">
                            <div class="stat-label">Speed (Ground)</div>
                            <div class="stat-value" id="speedDisplay">20</div>
                            <div class="stat-formula hidden-formula" id="speedFormula">20 + AGI Bonus + Mods = 20</div>
                            <div class="input-group"><label>Mods</label><input type="number" id="speedMods" value="0" onchange="updateCharacter()"></div>
                        </div>
                        <div class="stat-notes">
                            <div class="input-group">
                                <label>Notes</label>
                                <textarea id="speedNotes" class="auto-expand" oninput="autoExpand(this)" onchange="updateCharacter()"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Grapple | Stealth -->
                <div class="stat-box">
                    <div class="stat-label">Grapple</div>
                    <div class="stat-value" id="grappleDisplay">0</div>
                    <div class="stat-formula hidden-formula" id="grappleFormula">STR + AGI + Size + Mods = 0</div>
                    <div class="input-group"><label>Mods</label><input type="number" id="grappleMods" value="0" onchange="updateCharacter()"></div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Stealth</div>
                    <div class="stat-value" id="stealthDisplay">0</div>
                    <div class="stat-formula hidden-formula" id="stealthFormula">Size + Mods = 0</div>
                    <div class="input-group"><label>Mods</label><input type="number" id="stealthMods" value="0" onchange="updateCharacter()"></div>
                </div>
                <!-- Stat Notes - Full Row -->
                <div class="stat-box full-row">
                    <div class="stat-label">Stat Notes</div>
                    <textarea id="additionalStats" class="auto-expand" style="min-height:4rem;font-size:0.85rem" oninput="autoExpand(this)" onchange="updateCharacter()"></textarea>
                </div>`;
        }

        function generateHealth() {
            $('healthContainer').innerHTML = `
                <!-- Defense | Vitality -->
                <div class="stat-box">
                    <div class="stat-label">Defense</div>
                    <div class="combined-stat mb-05">
                        <div class="combined-stat-item"><div class="stat-value" id="defenseDisplay" style="margin:0">1</div><div class="label">Max</div></div>
                        <div class="combined-stat-item"><input type="number" id="currentDefense" value="0" style="width:50px;padding:0.25rem;font-size:1rem;font-weight:700" onchange="updateCharacter()"><div class="label">Current</div></div>
                    </div>
                    <div class="stat-formula hidden-formula" id="defenseFormula">AGI + FORT + Equip + Mods = 1 (min 1)</div>
                    <div class="input-group"><label>Mods</label><input type="number" id="defenseMods" value="0" onchange="updateCharacter()"></div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Vitality</div>
                    <div class="combined-stat mb-05">
                        <div class="combined-stat-item"><div class="stat-value" id="vitalityDisplay" style="margin:0">n/a</div><div class="label">Max</div></div>
                        <div class="combined-stat-item"><input type="number" id="currentVitality" value="1" style="width:50px;padding:0.25rem;font-size:1rem;font-weight:700" onchange="updateCharacter()"><div class="label">Current</div></div>
                    </div>
                    <div class="stat-formula hidden-formula" id="vitalityFormula">¬Ω Level + ¬Ω FORT + Mods</div>
                    <div class="input-group"><label>Mods</label><input type="number" id="vitalityMods" value="0" onchange="updateCharacter()"></div>
                </div>
                <!-- Tracker | Stress Threshold -->
                <div class="stat-box">
                    <div class="stat-label">Tracker</div>
                    <textarea id="tracker" class="auto-expand" style="min-height:5rem;font-size:0.85rem" oninput="autoExpand(this)" onchange="updateCharacter()"></textarea>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Stress Threshold</div>
                    <div class="combined-stat mb-05">
                        <div class="combined-stat-item"><div class="stat-value" id="stressThresholdDisplay" style="margin:0">n/a</div><div class="label">Threshold</div></div>
                        <div class="combined-stat-item"><input type="number" id="currentStress" value="0" style="width:50px;padding:0.25rem;font-size:1rem;font-weight:700" onchange="updateCharacter()"><div class="label">Current</div></div>
                    </div>
                    <div class="stat-formula hidden-formula" id="stressFormula">¬Ω Level + ¬Ω WILL + Mods (min 1)</div>
                    <div class="input-group"><label>Mods</label><input type="number" id="stressMods" value="0" onchange="updateCharacter()"></div>
                </div>
                <!-- Health Notes - Full Row -->
                <div class="stat-box full-row">
                    <div class="stat-label">Health Notes</div>
                    <textarea id="healthNotes" class="auto-expand" style="min-height:4rem;font-size:0.85rem" oninput="autoExpand(this)" onchange="updateCharacter()"></textarea>
                </div>`;
        }

        function generateWeapons() {
            $('weaponsContainer').innerHTML = [0,1,2].map(i => `
                <div class="card-block">
                    <div class="card-header">Weapon ${i+1}</div>
                    <div class="input-group mb-05"><label>Name</label><input type="text" id="weaponName${i}" placeholder="Weapon name" onchange="updateCharacter()"></div>
                    <div class="stats-row-3 mb-05">
                        <div class="input-group"><label>ATK Bonus</label><input type="text" id="weaponAtk${i}" placeholder="+0" onchange="updateCharacter()"></div>
                        <div class="input-group"><label>DMG</label><input type="text" id="weaponDmg${i}" placeholder="+0" onchange="updateCharacter()"></div>
                        <div class="input-group"><label>Ammo</label><input type="text" id="weaponAmmo${i}" placeholder="-" onchange="updateCharacter()"></div>
                    </div>
                    <div class="input-group"><label>Notes</label><textarea id="weaponNotes${i}" class="auto-expand" style="min-height:2rem" placeholder="Tags, special properties..." oninput="autoExpand(this)" onchange="updateCharacter()"></textarea></div>
                </div>`).join('');
        }

        function generateDefense() {
            const makeBlock = (type, label) => `
                <div class="card-block">
                    <div class="card-header">${label}</div>
                    <div class="input-group mb-05"><label>Name</label><input type="text" id="${type}Name" placeholder="${label} name" onchange="updateCharacter()"></div>
                    <div class="stats-row-2 mb-05">
                        <div class="stat-small"><label>DEF Bonus</label><input type="number" id="${type}DefBonus" value="0" min="0" onchange="updateCharacter()"></div>
                        <div class="stat-small"><label>DEX/AGI Pen.</label><input type="number" id="${type}Penalty" value="0" max="0" onchange="updateCharacter()"></div>
                    </div>
                    <div class="input-group"><label>Notes</label><textarea id="${type}Notes" class="auto-expand" style="min-height:2.5rem" placeholder="Tags, special properties..." oninput="autoExpand(this)" onchange="updateCharacter()"></textarea></div>
                </div>`;
            $('defenseContainer').innerHTML = makeBlock('armor', 'Armor') + makeBlock('equipment', 'Equipment') + `
                <div class="totals-box">
                    <div class="totals-grid">
                        <div><label class="form-label-sm">Total DEF Bonus</label><div class="font-bold" style="font-size:1.125rem" id="totalDefBonus">0</div></div>
                        <div><label class="form-label-sm">Total DEX/AGI Penalty</label><div class="font-bold" style="font-size:1.125rem" id="totalPenalty">0</div></div>
                    </div>
                </div>`;
        }

        function generateWounds() {
            $('woundsContainer').innerHTML = Array(10).fill().map((_, i) => 
                `<input type="text" id="wound${i}" placeholder="Wound/Condition ${i+1}" onchange="updateCharacter()">`
            ).join('');
        }

        function generateEquipmentSlots() {
            const slotIds = ['slotHead', 'slotNeck', 'slotChest', 'slotBack', 'slotArms', 'slotHands', 'slotBelt', 'slotLegsFeet'];
            $('equipmentSlotsContainer').innerHTML = EQUIPMENT_SLOTS.map((label, i) =>
                `<div class="slot-row"><label>${label}:</label><input type="text" id="${slotIds[i]}" onchange="updateCharacter()"></div>`
            ).join('');
        }

        function generateInventorySummary() {
            $('inventorySummary').innerHTML = `
                <div class="summary-box">
                    <label class="form-label-sm">Weight</label>
                    <div class="combined-stat">
                        <div class="combined-stat-item"><div class="value" id="currentWeightDisplay">0</div><div class="label">Current</div></div>
                        <div class="combined-stat-sep">/</div>
                        <div class="combined-stat-item"><div class="value" id="maxWeightDisplay">0</div><div class="label">Max</div></div>
                        <div style="font-size:0.875rem;color:var(--gray-500)">lbs</div>
                    </div>
                    <div class="formula-display hidden-formula" id="maxWeightFormula">Max = STR √ó 25 + Mods = 0</div>
                    <div class="mod-row"><label>Mods:</label><input type="number" id="maxWeightMods" value="0" onchange="updateCharacter()"></div>
                </div>
                <div class="summary-box">
                    <label class="form-label-sm">Bulky Items</label>
                    <div class="combined-stat">
                        <div class="combined-stat-item"><div class="value" id="currentBulkyDisplay">0</div><div class="label">Current</div></div>
                        <div class="combined-stat-sep">/</div>
                        <div class="combined-stat-item"><div class="value" id="maxBulkyDisplay">1</div><div class="label">Max</div></div>
                    </div>
                    <div class="formula-display hidden-formula" id="maxBulkyFormula">Max = 1 + STR√∑5 + Mods = 1</div>
                    <div class="mod-row"><label>Mods:</label><input type="number" id="maxBulkyMods" value="0" onchange="updateCharacter()"></div>
                </div>`;
        }

        function generateInventoryItems() {
            $('inventoryItemsContainer').innerHTML = Array(20).fill().map((_, i) => `
                <div class="inv-row">
                    <input type="text" id="itemName${i}" placeholder="Item ${i+1}" onchange="updateCharacter()">
                    <input type="number" step="0.1" min="0" id="itemWeight${i}" placeholder="0" onchange="updateCharacter()">
                    <select id="itemBulky${i}" onchange="updateCharacter()"><option value="no">No</option><option value="yes">Yes</option></select>
                </div>`).join('');
        }

        // ===== FORM <-> STATE =====
        function readFormValues() {
            character.characterName = sval('characterName');
            character.playerName = sval('playerName');
            character.archetype = sval('archetype');
            character.level = val('level') || null;
            character.description = sval('description');
            character.height = sval('height');
            character.weight = sval('weight');
            character.size = sval('size');

            [...ATTRS.physical, ...ATTRS.mental].forEach(attr => {
                character[attr.id] = { base: val(attr.id + 'Base'), mods: val(attr.id + 'Mods') };
            });

            character.luckBase = val('luckBase');
            character.luckMods = val('luckMods');
            character.currentLuck = val('currentLuck');
            character.currentVitality = val('currentVitality');
            character.vitalityMods = val('vitalityMods');
            character.currentDefense = val('currentDefense');
            character.defenseMods = val('defenseMods');
            character.currentStress = val('currentStress');
            character.stressMods = val('stressMods');
            character.tracker = sval('tracker');
            character.initiativeMods = val('initiativeMods');
            character.initiativeNotes = sval('initiativeNotes');
            character.actionPointsMods = val('actionPointsMods');
            character.speedMods = val('speedMods');
            character.speedNotes = sval('speedNotes');
            character.grappleMods = val('grappleMods');
            character.stealthMods = val('stealthMods');

            for (let i = 0; i < 3; i++) {
                character.weapons[i] = { name: sval('weaponName' + i), atkBonus: sval('weaponAtk' + i), dmg: sval('weaponDmg' + i), ammo: sval('weaponAmmo' + i), notes: sval('weaponNotes' + i) };
            }

            character.armor = { name: sval('armorName'), defBonus: val('armorDefBonus'), dexAgiPenalty: val('armorPenalty'), notes: sval('armorNotes') };
            character.equipment = { name: sval('equipmentName'), defBonus: val('equipmentDefBonus'), dexAgiPenalty: val('equipmentPenalty'), notes: sval('equipmentNotes') };

            // Wounds
            for (let i = 0; i < 10; i++) character.woundsConditions[i] = sval('wound' + i);

            // Equipment slots
            const slotMap = { head: 'slotHead', neck: 'slotNeck', chest: 'slotChest', back: 'slotBack', arms: 'slotArms', hands: 'slotHands', belt: 'slotBelt', legsFeet: 'slotLegsFeet' };
            Object.entries(slotMap).forEach(([key, id]) => character.equipmentSlots[key] = sval(id));

            // Inventory
            for (let i = 0; i < 20; i++) {
                character.inventoryItems[i] = { name: sval('itemName' + i), weight: fval('itemWeight' + i), bulky: $('itemBulky' + i).value === 'yes' };
            }
            character.maxWeightMods = val('maxWeightMods');
            character.maxBulkyMods = val('maxBulkyMods');
            character.inventoryNotes = sval('inventoryNotes');
            character.currency = sval('currency');
            character.languages = sval('languages');
            character.traits = sval('traits');
            character.proficiencies = sval('proficiencies');
            character.abilities = sval('abilities');
            character.healthNotes = sval('healthNotes');
            character.additionalStats = sval('additionalStats');
            character.notes1 = sval('notes1');
            character.notes2 = sval('notes2');
            character.notes3 = sval('notes3');
            character.notes4 = sval('notes4');
        }

        function populateForm() {
            $('characterName').value = character.characterName || '';
            $('playerName').value = character.playerName || '';
            $('archetype').value = character.archetype || '';
            $('level').value = character.level !== null ? character.level : '';
            $('description').value = character.description || '';
            $('height').value = character.height || '';
            $('weight').value = character.weight || '';
            $('size').value = character.size || 'Medium/0';

            [...ATTRS.physical, ...ATTRS.mental].forEach(attr => {
                $(attr.id + 'Base').value = character[attr.id].base || 0;
                $(attr.id + 'Mods').value = character[attr.id].mods || 0;
            });

            $('initiativeMods').value = character.initiativeMods || 0;
            $('initiativeNotes').value = character.initiativeNotes || '';
            $('actionPointsMods').value = character.actionPointsMods || 0;
            $('speedMods').value = character.speedMods || 0;
            $('speedNotes').value = character.speedNotes || '';
            $('defenseMods').value = character.defenseMods || 0;
            $('currentDefense').value = character.currentDefense || 0;
            $('vitalityMods').value = character.vitalityMods || 0;
            $('currentVitality').value = character.currentVitality || 1;
            $('stressMods').value = character.stressMods || 0;
            $('currentStress').value = character.currentStress || 0;
            $('luckBase').value = character.luckBase || 5;
            $('luckMods').value = character.luckMods || 0;
            $('currentLuck').value = character.currentLuck || 5;
            $('grappleMods').value = character.grappleMods || 0;
            $('stealthMods').value = character.stealthMods || 0;
            $('tracker').value = character.tracker || '';

            for (let i = 0; i < 3; i++) {
                $('weaponName' + i).value = character.weapons[i].name || '';
                $('weaponAtk' + i).value = character.weapons[i].atkBonus || '';
                $('weaponDmg' + i).value = character.weapons[i].dmg || '';
                $('weaponAmmo' + i).value = character.weapons[i].ammo || '';
                $('weaponNotes' + i).value = character.weapons[i].notes || '';
            }

            $('armorName').value = character.armor.name || '';
            $('armorDefBonus').value = character.armor.defBonus || 0;
            $('armorPenalty').value = character.armor.dexAgiPenalty || 0;
            $('armorNotes').value = character.armor.notes || '';
            $('equipmentName').value = character.equipment.name || '';
            $('equipmentDefBonus').value = character.equipment.defBonus || 0;
            $('equipmentPenalty').value = character.equipment.dexAgiPenalty || 0;
            $('equipmentNotes').value = character.equipment.notes || '';

            for (let i = 0; i < 10; i++) $('wound' + i).value = character.woundsConditions[i] || '';

            const slotMap = { head: 'slotHead', neck: 'slotNeck', chest: 'slotChest', back: 'slotBack', arms: 'slotArms', hands: 'slotHands', belt: 'slotBelt', legsFeet: 'slotLegsFeet' };
            Object.entries(slotMap).forEach(([key, id]) => $(id).value = character.equipmentSlots[key] || '');

            for (let i = 0; i < 20; i++) {
                $('itemName' + i).value = character.inventoryItems[i].name || '';
                $('itemWeight' + i).value = character.inventoryItems[i].weight || '';
                $('itemBulky' + i).value = character.inventoryItems[i].bulky ? 'yes' : 'no';
            }

            $('maxWeightMods').value = character.maxWeightMods || 0;
            $('maxBulkyMods').value = character.maxBulkyMods || 0;
            $('inventoryNotes').value = character.inventoryNotes || '';
            $('currency').value = character.currency || '';
            $('languages').value = character.languages || '';
            $('traits').value = character.traits || '';
            $('proficiencies').value = character.proficiencies || '';
            $('abilities').value = character.abilities || '';
            $('healthNotes').value = character.healthNotes || '';
            $('additionalStats').value = character.additionalStats || '';
            $('notes1').value = character.notes1 || '';
            $('notes2').value = character.notes2 || '';
            $('notes3').value = character.notes3 || '';
            $('notes4').value = character.notes4 || '';

            document.querySelectorAll('.auto-expand').forEach(el => autoExpand(el));
        }

        // ===== APPROVAL STAMP =====
        function updateStampDisplay() {
            const stampEl = $('approvalStamp');
            const messageEl = $('stampMessage');
            const editedEl = $('stampEdited');
            
            if (character._approvalStamp && character._approvalStamp.trim()) {
                // Truncate to 20 characters
                const message = character._approvalStamp.substring(0, 20);
                messageEl.textContent = message;
                stampEl.classList.add('visible');
                
                if (character._approvalEdited) {
                    editedEl.classList.add('visible');
                } else {
                    editedEl.classList.remove('visible');
                }
            } else {
                stampEl.classList.remove('visible');
            }
        }

        // ===== MAIN FUNCTIONS =====
        function updateCharacter() { readFormValues(); calculateDerivedStats(); }
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === tabId));
        }

        function saveCharacter() {
            readFormValues();
            
            // If a stamp was loaded, mark as edited on re-save
            if (stampWasLoaded && character._approvalStamp) {
                character._approvalEdited = true;
            }
            
            const blob = new Blob([JSON.stringify(character, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = (character.characterName || 'character') + '_sheet.json';
            link.click();
            URL.revokeObjectURL(link.href);
            
            // Update display to show EDITED if applicable
            updateStampDisplay();
        }

        function loadCharacter(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const loaded = JSON.parse(e.target.result);
                    // Merge with defaults to handle missing fields
                    Object.keys(character).forEach(key => {
                        if (loaded[key] !== undefined) character[key] = loaded[key];
                    });
                    // Handle legacy field name change
                    if (loaded.combatNotes && !loaded.healthNotes) {
                        character.healthNotes = loaded.combatNotes;
                    }
                    // Handle legacy maxLuck to luckBase conversion
                    if (loaded.maxLuck !== undefined && loaded.luckBase === undefined) {
                        character.luckBase = 5; // Default base
                    }
                    // Handle approval stamp
                    if (loaded._approvalStamp) {
                        character._approvalStamp = loaded._approvalStamp.substring(0, 20);
                        character._approvalEdited = loaded._approvalEdited || false;
                        stampWasLoaded = true;
                    }
                    populateForm();
                    calculateDerivedStats();
                    updateStampDisplay();
                } catch (err) { alert('Error loading character sheet. Please check the file format.'); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function showHelp() { $('helpModal').classList.remove('hidden'); }
        function hideHelp() { $('helpModal').classList.add('hidden'); }
        function showReadme() { $('readmeModal').classList.remove('hidden'); }
        function hideReadme() { $('readmeModal').classList.add('hidden'); }

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', () => {
            generateAttrs();
            generateStats();
            generateHealth();
            generateWeapons();
            generateDefense();
            generateWounds();
            generateEquipmentSlots();
            generateInventorySummary();
            generateInventoryItems();
            populateForm();
            calculateDerivedStats();
            
            // Collapse all sections by default
            document.querySelectorAll('.section-title').forEach(title => {
                title.classList.add('collapsed');
                const content = title.nextElementSibling;
                if (content && content.classList.contains('section-content')) {
                    content.classList.add('collapsed');
                }
            });
            
            // Modal close on backdrop click
            $('helpModal').addEventListener('click', e => { if (e.target === $('helpModal')) hideHelp(); });
            $('readmeModal').addEventListener('click', e => { if (e.target === $('readmeModal')) hideReadme(); });
        });
    </script>
</body>
</html>
