<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>These Lucky Stars - Digital Character Sheet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef } = React;
        const { Download, Upload, Calculator, User, Sword, Heart, Zap, Eye, MessageCircle, Briefcase, Hand, Brain, FileText, Swords, Package, HelpCircle, X } = lucide;

        const CharacterSheet = () => {
            const [activeTab, setActiveTab] = useState('overview');
            const [showHelp, setShowHelp] = useState(false);
            const [character, setCharacter] = useState({
                // Basic Info
                characterName: '',
                playerName: '',
                archetype: '',
                level: 1,
                description: '',
                height: '',
                weight: '',
                size: 'Medium/0',

                // Physical Attributes
                str: { base: 0, mods: 0 },
                agi: { base: 0, mods: 0 },
                dex: { base: 0, mods: 0 },
                fort: { base: 0, mods: 0 },

                // Mental Attributes
                kno: { base: 0, mods: 0 },
                ins: { base: 0, mods: 0 },
                cha: { base: 0, mods: 0 },
                will: { base: 0, mods: 0 },

                // Derived Stats
                maxLuck: 5,
                currentLuck: 5,
                maxVitality: 1,
                currentVitality: 1,
                maxDefense: 0,
                currentDefense: 0,
                maxStressThreshold: 1,
                currentStress: 0,
                initiative: 0,
                initiativeMods: 0,
                actionPoints: 4,
                speed: 20,
                speedNotes: '',
                grapple: 0,
                stealth: '',
                damageReduction: 0,
                damageReductionMods: 0,

                // Equipment
                weapons: [
                    { name: '', atkBonus: '', dmg: '', ammo: '', notes: '' },
                    { name: '', atkBonus: '', dmg: '', ammo: '', notes: '' },
                    { name: '', atkBonus: '', dmg: '', ammo: '', notes: '' }
                ],
                armor: { name: '', dmgReduction: 0, dexAgiPenalty: 0, notes: '' },
                equipment: { name: '', dmgReduction: 0, dexAgiPenalty: 0, notes: '' },

                // Equipment Slots
                equipmentSlots: {
                    head: '',
                    neck: '',
                    chest: '',
                    back: '',
                    arms: '',
                    hands: '',
                    belt: '',
                    legsFeet: ''
                },

                // Inventory
                currentWeight: 0,
                maxWeight: 0,
                currentBulkyItems: 0,
                maxBulkyItems: 1,
                currency: '',
                languages: '',
                inventoryItems: Array(20).fill().map(() => ({ name: '', weight: 0, bulky: false })),

                // Wounds & Conditions
                woundsConditions: Array(10).fill(''),

                // Character Features
                levelTracker: '',
                characterFeatures: ''
            });

            const fileInputRef = useRef(null);

            // Calculate derived stats based on attributes
            const calculateDerivedStats = (char) => {
                // Get size modifiers
                const getSizeModifiers = (size) => {
                    switch(size) {
                        case 'Tiny/-2': return { str: -4, agi: 4, grapple: -2 };
                        case 'Small/-1': return { str: -2, agi: 2, grapple: -1 };
                        case 'Medium/0': return { str: 0, agi: 0, grapple: 0 };
                        case 'Large/+1': return { str: 2, agi: -2, grapple: 1 };
                        case 'Huge/+2': return { str: 4, agi: -4, grapple: 2 };
                        default: return { str: 0, agi: 0, grapple: 0 };
                    }
                };

                const sizeModifiers = getSizeModifiers(char.size);

                const getBonus = (attr, sizeMod = 0) => Math.floor((attr.base + attr.mods + sizeMod) / 1) || 0;

                const agiBonus = getBonus(char.agi, sizeModifiers.agi);
                const fortBonus = getBonus(char.fort);
                const willBonus = getBonus(char.will);
                const strBonus = getBonus(char.str, sizeModifiers.str);
                const dexBonus = getBonus(char.dex);
                const insBonus = getBonus(char.ins);

                // Calculate inventory totals
                const inventoryWeight = char.inventoryItems ? char.inventoryItems.reduce((total, item) => total + (item.weight || 0), 0) : 0;
                const inventoryBulky = char.inventoryItems ? char.inventoryItems.reduce((total, item) => total + (item.bulky ? 1 : 0), 0) : 0;

                // Calculate equipment penalties
                const equipmentDexPenalty = (char.armor.dexAgiPenalty || 0) + (char.equipment.dexAgiPenalty || 0);
                const equipmentAgiPenalty = equipmentDexPenalty;

                // Calculate total damage reduction
                const totalDamageReduction = Math.max(0, (char.armor.dmgReduction || 0)) + Math.max(0, (char.equipment.dmgReduction || 0)) + (char.damageReductionMods || 0);

                return {
                    ...char,
                    sizeModifiers,
                    equipmentPenalties: { dex: equipmentDexPenalty, agi: equipmentAgiPenalty },
                    initiative: agiBonus + dexBonus + insBonus + (char.initiativeMods || 0),
                    maxDefense: agiBonus + fortBonus,
                    currentDefense: char.currentDefense || agiBonus + fortBonus,
                    maxVitality: Math.max(1, Math.floor(char.level / 2) + Math.floor(Math.max(0, char.fort.base) / 2)),
                    maxStressThreshold: Math.max(1, Math.floor(char.level / 2) + Math.floor(willBonus / 2)),
                    speed: 20 + (agiBonus >= 0 ? Math.floor(agiBonus / 2) * 5 : -5),
                    grapple: strBonus + agiBonus + sizeModifiers.grapple,
                    maxWeight: Math.max(0, char.str.base + char.str.mods + sizeModifiers.str) * 25,
                    maxBulkyItems: 1 + Math.floor(Math.max(0, char.str.base + char.str.mods + sizeModifiers.str) / 5),
                    currentWeight: inventoryWeight,
                    currentBulkyItems: inventoryBulky,
                    damageReduction: totalDamageReduction
                };
            };

            const updateCharacter = (updates) => {
                setCharacter(prev => calculateDerivedStats({ ...prev, ...updates }));
            };

            const updateAttribute = (attr, field, value) => {
                const numValue = parseInt(value) || 0;
                updateCharacter({
                    [attr]: { ...character[attr], [field]: numValue }
                });
            };

            const updateWeapon = (index, field, value) => {
                const newWeapons = [...character.weapons];
                newWeapons[index] = { ...newWeapons[index], [field]: value };
                updateCharacter({ weapons: newWeapons });
            };

            const updateWoundCondition = (index, value) => {
                const newWounds = [...character.woundsConditions];
                newWounds[index] = value;
                updateCharacter({ woundsConditions: newWounds });
            };

            const updateInventoryItem = (index, field, value) => {
                const newItems = [...character.inventoryItems];
                if (field === 'bulky') {
                    newItems[index] = { ...newItems[index], [field]: value === 'yes' };
                } else if (field === 'weight') {
                    newItems[index] = { ...newItems[index], [field]: parseFloat(value) || 0 };
                } else {
                    newItems[index] = { ...newItems[index], [field]: value };
                }
                updateCharacter({ inventoryItems: newItems });
            };

            const updateEquipmentSlot = (slot, value) => {
                updateCharacter({
                    equipmentSlots: { ...character.equipmentSlots, [slot]: value }
                });
            };

            const saveCharacter = () => {
                const dataStr = JSON.stringify(character, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${character.characterName || 'character'}_sheet.json`;
                link.click();
                URL.revokeObjectURL(url);
            };

            const loadCharacter = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const loadedCharacter = JSON.parse(e.target.result);
                            setCharacter(calculateDerivedStats(loadedCharacter));
                        } catch (error) {
                            alert('Error loading character sheet. Please check the file format.');
                        }
                    };
                    reader.readAsText(file);
                }
            };

            const AttributeBlock = ({ label, attr, icon: Icon }) => {
                const sizeModifier = character.sizeModifiers && (attr === 'str' || attr === 'agi') ? character.sizeModifiers[attr] : 0;
                const equipmentPenalty = character.equipmentPenalties && (attr === 'dex' || attr === 'agi') ? character.equipmentPenalties[attr] : 0;
                const total = (character[attr].base + character[attr].mods + sizeModifier + equipmentPenalty) || 0;

                return React.createElement('div', { className: "bg-gray-50 p-3 rounded-lg border" },
                    React.createElement('div', { className: "flex items-center gap-2 mb-2" },
                        React.createElement(Icon, { size: 16, className: "text-blue-600" }),
                        React.createElement('label', { className: "font-semibold text-sm" }, `${label}:`)
                    ),
                    React.createElement('div', { className: "flex gap-2 mb-2" },
                        React.createElement('div', { className: "flex-1" },
                            React.createElement('label', { className: "block text-xs text-gray-600 mb-1" }, "Base"),
                            React.createElement('input', {
                                type: "number",
                                value: character[attr].base,
                                onChange: (e) => updateAttribute(attr, 'base', e.target.value),
                                className: "w-full p-1 border rounded text-center"
                            })
                        ),
                        React.createElement('div', { className: "flex-1" },
                            React.createElement('label', { className: "block text-xs text-gray-600 mb-1" }, "Mods"),
                            React.createElement('input', {
                                type: "number",
                                value: character[attr].mods,
                                onChange: (e) => updateAttribute(attr, 'mods', e.target.value),
                                className: "w-full p-1 border rounded text-center"
                            })
                        )
                    ),
                    React.createElement('div', { className: "text-center" },
                        React.createElement('div', { className: "text-lg font-bold text-blue-800 flex items-center justify-center gap-1" },
                            total,
                            sizeModifier !== 0 && React.createElement('span', { className: "text-xs text-gray-500" },
                                `(${sizeModifier > 0 ? '+' : ''}${sizeModifier} size)`
                            ),
                            equipmentPenalty !== 0 && React.createElement('span', { className: "text-xs text-gray-500" },
                                `(${equipmentPenalty > 0 ? '+' : ''}${equipmentPenalty} equip)`
                            )
                        ),
                        React.createElement('div', { className: "text-xs text-gray-500" }, "Total")
                    )
                );
            };

            const TabButton = ({ id, label, icon: Icon, isActive, onClick }) => (
                React.createElement('button', {
                    onClick: () => onClick(id),
                    className: `flex items-center gap-2 px-4 py-2 rounded-t-lg font-semibold transition-colors ${
                        isActive 
                            ? 'bg-blue-900 text-white border-b-2 border-blue-900' 
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`
                },
                    React.createElement(Icon, { size: 16 }),
                    label
                )
            );

            return React.createElement('div', { className: "max-w-6xl mx-auto p-4 bg-white" },
                // Header
                React.createElement('div', { className: "bg-blue-900 text-white p-4 rounded-t-lg" },
                    React.createElement('h1', { className: "text-xl font-bold text-center" }, "These Lucky Stars v.4.25 - Digital Character Sheet")
                ),

                // Save/Load Controls
                React.createElement('div', { className: "bg-gray-100 p-3 border-x flex gap-2 justify-center" },
                    React.createElement('button', {
                        onClick: saveCharacter,
                        className: "flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors"
                    },
                        React.createElement(Download, { size: 16 }),
                        "Save Sheet"
                    ),
                    React.createElement('button', {
                        onClick: () => fileInputRef.current?.click(),
                        className: "flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors"
                    },
                        React.createElement(Upload, { size: 16 }),
                        "Load Sheet"
                    ),
                    React.createElement('button', {
                        onClick: () => setShowHelp(true),
                        className: "flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition-colors"
                    },
                        React.createElement(HelpCircle, { size: 16 }),
                        "How To Use"
                    ),
                    React.createElement('input', {
                        ref: fileInputRef,
                        type: "file",
                        accept: ".json",
                        onChange: loadCharacter,
                        className: "hidden"
                    })
                ),

                // Help Modal
                showHelp && React.createElement('div', { className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" },
                    React.createElement('div', { className: "bg-white rounded-lg p-6 max-w-lg w-full max-h-96 overflow-y-auto" },
                        React.createElement('div', { className: "flex justify-between items-center mb-4" },
                            React.createElement('h2', { className: "text-xl font-bold" }, "How To Use"),
                            React.createElement('button', {
                                onClick: () => setShowHelp(false),
                                className: "text-gray-500 hover:text-gray-700"
                            },
                                React.createElement(X, { size: 20 })
                            )
                        ),
                        React.createElement('div', { className: "space-y-4 text-sm" },
                            React.createElement('p', null, "This character companion is designed for use with the These Lucky Stars tabletop rpg system."),
                            React.createElement('p', null, "You can fill the sheet and download a copy to reload into the app whenever you wish to visit that character."),
                            React.createElement('div', null,
                                React.createElement('h3', { className: "font-semibold mb-2" }, "Auto-Calculations:"),
                                React.createElement('p', null, "Attribute totals and most base stats are calculated for you. Modifiers from size and defensive equipment will be applied directly to the totals in Stats. In order for the calculations to work, DMG Reduction must be entered as 0 or positive, and DEX/AGI Penalty must be entered as 0 or negative.")
                            )
                        ),
                        React.createElement('div', { className: "mt-6 flex justify-end" },
                            React.createElement('button', {
                                onClick: () => setShowHelp(false),
                                className: "bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors"
                            }, "Got it")
                        )
                    )
                ),

                // Tab Navigation
                React.createElement('div', { className: "border-x bg-gray-50 p-3" },
                    React.createElement('div', { className: "flex gap-1" },
                        React.createElement(TabButton, { 
                            id: "overview", 
                            label: "Overview", 
                            icon: FileText, 
                            isActive: activeTab === 'overview', 
                            onClick: setActiveTab 
                        }),
                        React.createElement(TabButton, { 
                            id: "combat", 
                            label: "Combat", 
                            icon: Swords, 
                            isActive: activeTab === 'combat', 
                            onClick: setActiveTab 
                        }),
                        React.createElement(TabButton, { 
                            id: "inventory", 
                            label: "Inventory", 
                            icon: Package, 
                            isActive: activeTab === 'inventory', 
                            onClick: setActiveTab 
                        })
                    )
                ),

                // Tab Content
                React.createElement('div', { className: "border-x border-b rounded-b-lg p-6" },
                    // OVERVIEW TAB
                    activeTab === 'overview' && React.createElement('div', { className: "space-y-6" },
                        // Basic Information
                        React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 