
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attribute Array Converter - Probability Weighted</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        .system-selector {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        .radio-group {
            display: flex;
            gap: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .radio-option input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .radio-option label {
            font-weight: 600;
            cursor: pointer;
            color: #333;
        }
        .input-section {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Responsive grid layouts */
        @media (min-width: 768px) {
            .input-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            .array-display {
                grid-template-columns: repeat(4, 1fr);
            }
            .conversion-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 767px) {
            .input-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .array-display {
                grid-template-columns: repeat(2, 1fr);
            }
            .conversion-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .input-grid input {
            padding: 12px;
            font-size: 1.1em;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-weight: 600;
        }
        .input-grid input:focus {
            outline: none;
            border-color: #667eea;
        }
        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        button.secondary {
            background: #6b7280;
        }
        .results {
            display: none;
            margin-top: 25px;
        }
        .result-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .result-card h3 {
            margin: 0 0 15px 0;
            font-size: 1.3em;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
        }
        .array-display {
            display: grid;
            gap: 10px;
            margin: 20px 0;
        }
        .array-value {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .stat-row:last-child {
            border-bottom: none;
        }
        .conversion-card {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        .conversion-card h3 {
            color: #667eea;
            margin-top: 0;
        }
        .conversion-grid {
            display: grid;
            gap: 10px;
            margin: 20px 0;
        }
        .converted-value {
            background: #667eea;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
        }
        .info-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .info-box p {
            margin: 5px 0;
            color: #92400e;
        }
        .note-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            color: #333;
            font-size: 0.9em;
        }
        .prob-display {
            background: rgba(255,255,255,0.15);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Attribute Array Converter</h1>
        <p class="subtitle">Probability-weighted conversion between dice systems</p>

        <div class="system-selector">
            <h3 style="margin-top: 0; text-align: center; color: #667eea;">Select Input System:</h3>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="input-1d6-1d4" name="inputSystem" value="1d6-1d4" checked>
                    <label for="input-1d6-1d4">Old TLS</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="input-1d4-1d4" name="inputSystem" value="1d4-1d4">
                    <label for="input-1d4-1d4">New TLS</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="input-d20a" name="inputSystem" value="d20a">
                    <label for="input-d20a">D20A</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="input-d20b" name="inputSystem" value="d20b">
                    <label for="input-d20b">D20B</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="input-d20c" name="inputSystem" value="d20c">
                    <label for="input-d20c">D20C</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="input-d20dd" name="inputSystem" value="d20dd">
                    <label for="input-d20dd">D20DD</label>
                </div>
            </div>
        </div>

        <div class="system-selector">
            <h3 style="margin-top: 0; text-align: center; color: #667eea;">Select Output System:</h3>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="output-1d6-1d4" name="outputSystem" value="1d6-1d4">
                    <label for="output-1d6-1d4">Old TLS</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="output-1d4-1d4" name="outputSystem" value="1d4-1d4" checked>
                    <label for="output-1d4-1d4">New TLS</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="output-d20a" name="outputSystem" value="d20a">
                    <label for="output-d20a">D20A</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="output-d20b" name="outputSystem" value="d20b">
                    <label for="output-d20b">D20B</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="output-d20c" name="outputSystem" value="d20c">
                    <label for="output-d20c">D20C</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="output-d20dd" name="outputSystem" value="d20dd">
                    <label for="output-d20dd">D20DD</label>
                </div>
            </div>
        </div>

        <div class="input-section">
            <h3 style="margin-top: 0; color: #333;">Enter Your 8 Attribute Values:</h3>
            <p style="color: #666; margin-bottom: 5px;">Order doesn't matter</p>
            <p id="inputNote" style="color: #f59e0b; margin-bottom: 15px; font-size: 0.9em; font-weight: 600;"></p>
            <div class="input-grid">
                <input type="number" id="attr1" min="-5" max="24" placeholder="1">
                <input type="number" id="attr2" min="-5" max="24" placeholder="2">
                <input type="number" id="attr3" min="-5" max="24" placeholder="3">
                <input type="number" id="attr4" min="-5" max="24" placeholder="4">
                <input type="number" id="attr5" min="-5" max="24" placeholder="5">
                <input type="number" id="attr6" min="-5" max="24" placeholder="6">
                <input type="number" id="attr7" min="-5" max="24" placeholder="7">
                <input type="number" id="attr8" min="-5" max="24" placeholder="8">
            </div>
            <div class="button-group">
                <button onclick="calculate()">Convert Array</button>
                <button class="secondary" onclick="clearInputs()">Clear</button>
                <button class="secondary" onclick="generateRandom()">Random Example</button>
            </div>
        </div>

        <div class="info-box">
            <p><strong>How it works:</strong></p>
            <p>â€¢ Supports TLS systems (|1d6-1d4|, |1d4-1d4|) and D20 systems (4d6 drop lowest, 3d6, 3d6 reroll ones, 4d6 drop lowest and reroll ones)</p>
            <p>â€¢ For D20 systems: Enter modifiers (-5 to +5), not ability scores. The tool converts them internally.</p>
            <p>â€¢ Calculates the probability of getting your exact array combination</p>
            <p>â€¢ Converts each value while considering both individual odds and array rarity</p>
            <p>â€¢ Finds an equivalent array with similar probability in the target system</p>
        </div>

        <div class="results" id="results">
            <div class="result-card">
                <h3>ðŸ“Š Your Input Array</h3>
                <p style="text-align: center; opacity: 0.9; margin-bottom: 10px;" id="inputSystemName">-</p>
                <div class="array-display" id="inputArray"></div>
                <div class="stat-row">
                    <span>Total:</span>
                    <span id="inputTotal" style="font-weight: bold; font-size: 1.2em;">-</span>
                </div>
                <div class="prob-display">
                    <strong>Array Probability:</strong> <span id="inputProb">-</span><br>
                    <strong>Rarity:</strong> <span id="inputRarity">-</span>
                </div>
            </div>

            <div class="conversion-card">
                <h3>ðŸ”„ Converted Array</h3>
                <p style="text-align: center; color: #666; margin: 10px 0;">In <strong id="outputSystemName">-</strong> system:</p>
                <div class="conversion-grid" id="outputArray"></div>
                <div style="text-align: center; margin-top: 15px;">
                    <p style="color: #666;"><strong>Total:</strong> <span id="outputTotal" style="color: #667eea; font-weight: bold; font-size: 1.3em;">-</span></p>
                </div>
                <div style="background: rgba(102, 126, 234, 0.1); padding: 10px; border-radius: 5px; margin: 10px 0;">
                    <strong style="color: #667eea;">Array Probability:</strong> <span id="outputProb">-</span><br>
                    <strong style="color: #667eea;">Rarity:</strong> <span id="outputRarity">-</span>
                </div>
                <div class="note-box">
                    <p><strong>Conversion Method:</strong> This algorithm considers both the z-score of each individual value AND the probability of getting that specific combination. It optimizes to find an array in the target system with similar rarity while maintaining the relative distribution of high/low values.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const systems = {
            '1d6-1d4': {
                name: 'Old TLS: |1d6 - 1d4| (reroll zeros)',
                probs: {1: 7/20, 2: 6/20, 3: 4/20, 4: 2/20, 5: 1/20},
                expectedPerAttr: 2.2,
                stdDevPerAttr: 1.166,
                minVal: 1,
                maxVal: 5,
                isD20: false
            },
            '1d4-1d4': {
                name: 'New TLS: |1d4 - 1d4|',
                probs: {0: 4/16, 1: 6/16, 2: 4/16, 3: 2/16},
                expectedPerAttr: 1.25,
                stdDevPerAttr: 0.968,
                minVal: 0,
                maxVal: 3,
                isD20: false
            },
            'd20a': {
                name: 'D20A: 4d6 drop the lowest',
                probs: {3: 0.000772, 4: 0.003086, 5: 0.007716, 6: 0.016204, 7: 0.029321, 8: 0.047840, 9: 0.070216, 10: 0.094136, 11: 0.114198, 12: 0.128858, 13: 0.132716, 14: 0.123457, 15: 0.101080, 16: 0.072531, 17: 0.041667, 18: 0.016204},
                expectedPerAttr: 12.2446,
                stdDevPerAttr: 2.8468,
                minVal: 3,
                maxVal: 18,
                isD20: true
            },
            'd20b': {
                name: 'D20B: 3d6',
                probs: {3: 0.004630, 4: 0.013889, 5: 0.027778, 6: 0.046296, 7: 0.069444, 8: 0.097222, 9: 0.115741, 10: 0.125000, 11: 0.125000, 12: 0.115741, 13: 0.097222, 14: 0.069444, 15: 0.046296, 16: 0.027778, 17: 0.013889, 18: 0.004630},
                expectedPerAttr: 10.5,
                stdDevPerAttr: 2.9580,
                minVal: 3,
                maxVal: 18,
                isD20: true
            },
            'd20c': {
                name: 'D20C: 3d6 reroll ones',
                probs: {3: 0.000751, 4: 0.004508, 5: 0.013524, 6: 0.028550, 7: 0.049587, 8: 0.076634, 9: 0.105184, 10: 0.126221, 11: 0.135237, 12: 0.132231, 13: 0.117205, 14: 0.090158, 15: 0.060105, 16: 0.036063, 17: 0.018032, 18: 0.006011},
                expectedPerAttr: 11.1818,
                stdDevPerAttr: 2.7724,
                minVal: 3,
                maxVal: 18,
                isD20: true
            },
            'd20dd': {
                name: 'D20DD: 4d6 drop the lowest and reroll ones',
                probs: {3: 0.000068, 4: 0.000546, 5: 0.002186, 6: 0.007103, 7: 0.016392, 8: 0.031145, 9: 0.053002, 10: 0.080869, 11: 0.107643, 12: 0.131139, 13: 0.143706, 14: 0.142067, 15: 0.121303, 16: 0.089611, 17: 0.052455, 18: 0.020764},
                expectedPerAttr: 12.8392,
                stdDevPerAttr: 2.6099,
                minVal: 3,
                maxVal: 18,
                isD20: true
            }
        };

        // Convert D20 modifier to ability score
        function modifierToScore(modifier) {
            // Standard D&D 5e modifier-to-score mapping
            // Use the middle value of each score range
            const mapping = {
                '-5': 1,
                '-4': 3,
                '-3': 5,
                '-2': 7,
                '-1': 9,
                '0': 10,
                '1': 13,
                '2': 15,
                '3': 17,
                '4': 18,
                '5': 20
            };
            return mapping[modifier.toString()] || 10;
        }

        // Convert D20 ability score to modifier
        function scoreToModifier(score) {
            return Math.floor((score - 10) / 2);
        }

        function factorial(n) {
            if (n <= 1) return 1;
            return n * factorial(n - 1);
        }

        function calculateArrayProbability(values, system) {
            const systemData = systems[system];
            const counts = {};
            values.forEach(v => counts[v] = (counts[v] || 0) + 1);
            
            let multinomial = factorial(8);
            Object.values(counts).forEach(count => multinomial /= factorial(count));
            
            let prob = multinomial;
            Object.entries(counts).forEach(([value, count]) => {
                const p = systemData.probs[value] || 0;
                prob *= Math.pow(p, count);
            });
            
            return prob;
        }

        function logProbability(prob) {
            return Math.log10(prob);
        }

        function getRarityDescription(prob) {
            const log = logProbability(prob);
            if (log > -3) return "Very Common";
            if (log > -4) return "Common";
            if (log > -5) return "Uncommon";
            if (log > -6) return "Rare";
            if (log > -7) return "Very Rare";
            return "Extremely Rare";
        }

        function convertValueBasic(value, fromSystem, toSystem) {
            const fromStats = systems[fromSystem];
            const toStats = systems[toSystem];
            const zScore = (value - fromStats.expectedPerAttr) / fromStats.stdDevPerAttr;
            const convertedValue = toStats.expectedPerAttr + (zScore * toStats.stdDevPerAttr);
            return Math.max(toStats.minVal, Math.min(toStats.maxVal, Math.round(convertedValue)));
        }

        function optimizeArray(baseArray, targetProb, targetSystem, maxIterations = 10000) {
            const systemData = systems[targetSystem];
            let bestArray = [...baseArray];
            let bestScore = Math.abs(logProbability(calculateArrayProbability(bestArray, targetSystem)) - 
                                     logProbability(targetProb));
            
            for (let iter = 0; iter < maxIterations; iter++) {
                let testArray = [...bestArray];
                const idx = Math.floor(Math.random() * 8);
                const adjustment = Math.random() < 0.5 ? -1 : 1;
                testArray[idx] = Math.max(systemData.minVal, 
                                         Math.min(systemData.maxVal, testArray[idx] + adjustment));
                
                const testProb = calculateArrayProbability(testArray, targetSystem);
                const testScore = Math.abs(logProbability(testProb) - logProbability(targetProb));
                const totalDiff = Math.abs(testArray.reduce((a,b) => a+b, 0) - 
                                          baseArray.reduce((a,b) => a+b, 0)) * 0.1;
                
                const combinedScore = testScore + totalDiff;
                const bestCombinedScore = bestScore + Math.abs(bestArray.reduce((a,b) => a+b, 0) - 
                                                               baseArray.reduce((a,b) => a+b, 0)) * 0.1;
                
                if (combinedScore < bestCombinedScore) {
                    bestArray = testArray;
                    bestScore = testScore;
                }
            }
            
            return bestArray;
        }

        function getInputSystem() {
            return document.querySelector('input[name="inputSystem"]:checked').value;
        }

        function getOutputSystem() {
            return document.querySelector('input[name="outputSystem"]:checked').value;
        }

        function updateInputNote() {
            const inputSystem = getInputSystem();
            const systemData = systems[inputSystem];
            const noteElement = document.getElementById('inputNote');

            if (systemData.isD20) {
                noteElement.textContent = 'For D20 systems: Enter MODIFIERS (-5 to +5), not ability scores';
            } else {
                noteElement.textContent = '';
            }
        }

        function getInputValues() {
            const inputSystem = getInputSystem();
            const systemData = systems[inputSystem];
            const values = [];

            for (let i = 1; i <= 8; i++) {
                const val = parseInt(document.getElementById('attr' + i).value);
                if (isNaN(val)) return null;

                // If it's a D20 system, convert modifier to score
                if (systemData.isD20) {
                    values.push(modifierToScore(val));
                } else {
                    values.push(val);
                }
            }
            return values;
        }

        function getDisplayValues() {
            const values = [];
            for (let i = 1; i <= 8; i++) {
                const val = parseInt(document.getElementById('attr' + i).value);
                if (isNaN(val)) return null;
                values.push(val);
            }
            return values;
        }

        function clearInputs() {
            for (let i = 1; i <= 8; i++) {
                document.getElementById('attr' + i).value = '';
            }
            document.getElementById('results').style.display = 'none';
        }

        function generateRandom() {
            const system = getInputSystem();
            const systemData = systems[system];

            function rollDie(sides) {
                return Math.floor(Math.random() * sides) + 1;
            }

            function roll4d6DropLowest() {
                const rolls = [rollDie(6), rollDie(6), rollDie(6), rollDie(6)];
                rolls.sort((a, b) => a - b);
                return rolls.slice(1).reduce((a, b) => a + b, 0);
            }

            function roll3d6() {
                return rollDie(6) + rollDie(6) + rollDie(6);
            }

            function roll3d6RerollOnes() {
                let rolls = [rollDie(6), rollDie(6), rollDie(6)];
                rolls = rolls.map(r => r === 1 ? rollDie(6) : r);
                return rolls.reduce((a, b) => a + b, 0);
            }

            function roll4d6DropLowestRerollOnes() {
                let rolls = [rollDie(6), rollDie(6), rollDie(6), rollDie(6)];
                rolls = rolls.map(r => r === 1 ? rollDie(6) : r);
                rolls.sort((a, b) => a - b);
                return rolls.slice(1).reduce((a, b) => a + b, 0);
            }

            for (let i = 1; i <= 8; i++) {
                let value;
                if (system === '1d6-1d4') {
                    do {
                        value = Math.abs(rollDie(6) - rollDie(4));
                    } while (value === 0);
                } else if (system === '1d4-1d4') {
                    value = Math.abs(rollDie(4) - rollDie(4));
                } else if (system === 'd20a') {
                    value = roll4d6DropLowest();
                } else if (system === 'd20b') {
                    value = roll3d6();
                } else if (system === 'd20c') {
                    value = roll3d6RerollOnes();
                } else if (system === 'd20dd') {
                    value = roll4d6DropLowestRerollOnes();
                }

                // If D20 system, convert score to modifier for display
                if (systemData.isD20) {
                    value = scoreToModifier(value);
                }

                document.getElementById('attr' + i).value = value;
            }

            calculate();
        }

        function calculate() {
            const values = getInputValues();
            const displayValues = getDisplayValues();
            if (!values || !displayValues) {
                alert('Please enter all 8 attribute values');
                return;
            }

            const inputSystem = getInputSystem();
            const outputSystem = getOutputSystem();

            if (inputSystem === outputSystem) {
                alert('Please select different input and output systems');
                return;
            }

            const inputStats = systems[inputSystem];
            const outputStats = systems[outputSystem];

            const inputProb = calculateArrayProbability(values, inputSystem);
            const inputTotal = values.reduce((a, b) => a + b, 0);

            const basicConverted = values.map(v => convertValueBasic(v, inputSystem, outputSystem));
            const optimizedArray = optimizeArray(basicConverted, inputProb, outputSystem);

            const outputProb = calculateArrayProbability(optimizedArray, outputSystem);
            const outputTotal = optimizedArray.reduce((a, b) => a + b, 0);

            // Display logic
            document.getElementById('results').style.display = 'block';
            document.getElementById('inputSystemName').textContent = inputStats.name;

            let inputHTML = '';
            if (inputStats.isD20) {
                // Display as modifiers
                displayValues.forEach(val => inputHTML += `<div class="array-value">${val >= 0 ? '+' : ''}${val}</div>`);
            } else {
                displayValues.forEach(val => inputHTML += `<div class="array-value">${val}</div>`);
            }
            document.getElementById('inputArray').innerHTML = inputHTML;
            document.getElementById('inputTotal').textContent = inputStats.isD20
                ? displayValues.reduce((a, b) => a + b, 0)
                : inputTotal;
            document.getElementById('inputProb').textContent =
                inputProb.toExponential(3) + ' (1 in ' + Math.round(1/inputProb).toLocaleString() + ')';
            document.getElementById('inputRarity').textContent = getRarityDescription(inputProb);

            document.getElementById('outputSystemName').textContent = outputStats.name;

            let outputHTML = '';
            if (outputStats.isD20) {
                // Display as modifiers
                optimizedArray.forEach(val => {
                    const mod = scoreToModifier(val);
                    outputHTML += `<div class="converted-value">${mod >= 0 ? '+' : ''}${mod}</div>`;
                });
            } else {
                optimizedArray.forEach(val => outputHTML += `<div class="converted-value">${val}</div>`);
            }
            document.getElementById('outputArray').innerHTML = outputHTML;

            if (outputStats.isD20) {
                const modTotal = optimizedArray.map(scoreToModifier).reduce((a, b) => a + b, 0);
                document.getElementById('outputTotal').textContent = modTotal;
            } else {
                document.getElementById('outputTotal').textContent = outputTotal;
            }

            document.getElementById('outputProb').textContent =
                outputProb.toExponential(3) + ' (1 in ' + Math.round(1/outputProb).toLocaleString() + ')';
            document.getElementById('outputRarity').textContent = getRarityDescription(outputProb);

            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        for (let i = 1; i <= 8; i++) {
            document.getElementById('attr' + i).addEventListener('keypress', function(e) {
                if (e.key === 'Enter') calculate();
            });
        }

        // Add event listeners for system selection changes
        document.querySelectorAll('input[name="inputSystem"]').forEach(radio => {
            radio.addEventListener('change', updateInputNote);
        });

        // Initialize the input note on page load
        window.addEventListener('DOMContentLoaded', updateInputNote);
    </script>
</body>
</html>